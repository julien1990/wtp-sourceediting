<HTML><HEAD><META CONTENT="text/html; charset=UTF-8" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="tl"><A HREF="http://www.eclemma.org/">EMMA</A> Coverage Report (generated Tue Jun 09 19:59:05 GMT 2009)</TH></TR><TR><TD CLASS="nv">[<A HREF="../xslUnitTestCoverage.html">all classes</A>][<A HREF="8.html">org.eclipse.jst.jsp.core.internal.document</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">PageDirectiveAdapterImpl.java</SPAN>]</H2><TABLE CELLSPACING="0" WIDTH="100%"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>PageDirectiveAdapterImpl.java</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/721)</TD><TD CLASS="h">0%   (0/198)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE CLASS="cn" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">PageDirectiveAdapterImpl</A></TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/32)</TD><TD CLASS="h">0%   (0/721)</TD><TD CLASS="h">0%   (0/198)</TD></TR><TR><TD CLASS="f"><A HREF="#0">&lt;static initializer&gt;</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/17)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2">PageDirectiveAdapterImpl (INodeNotifier): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/79)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR><TD CLASS="f"><A HREF="#3">adapt (INodeNotifier, Object): INodeAdapter</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/33)</TD><TD CLASS="h">0%   (0/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4">addEmbeddedFactory (INodeAdapterFactory): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/6)</TD><TD CLASS="h">0%   (0/2)</TD></TR><TR><TD CLASS="f"><A HREF="#5">changedContentType (int, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/23)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6">changedLanguage (int, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/24)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#7">changedPageEncoding (int, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8">getContentDescription (IDocument): IContentDescription</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/4)</TD></TR><TR><TD CLASS="f"><A HREF="#9">getContentDescription (Reader): IContentDescription</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/35)</TD><TD CLASS="h">0%   (0/13)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a">getContentType (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#b">getDefaultContentType (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c">getDefaultEmbeddedType (): EmbeddedTypeHandler</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/5)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#d">getDefaultLanguage (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/20)</TD><TD CLASS="h">0%   (0/7)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#e">getEmbeddedContentTypeRegistry (): EmbeddedTypeRegistry</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/2)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#f">getEmbeddedType (): EmbeddedTypeHandler</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#10">getFile (IStructuredModel): IFile</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/21)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#11">getHandlerFor (String): EmbeddedTypeHandler</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/13)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#12">getLanguage (): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/10)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR><TD CLASS="f"><A HREF="#13">getMimeTypeFromContentTypeValue (String): String</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/76)</TD><TD CLASS="h">0%   (0/23)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#14">getTarget (): INodeNotifier</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/3)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#15">hasValue (String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/9)</TD><TD CLASS="h">0%   (0/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#16">isAdapterForType (Object): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/7)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR><TD CLASS="f"><A HREF="#17">languageKnown (String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/16)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#18">languageStateChanged (String, String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/6)</TD></TR><TR><TD CLASS="f"><A HREF="#19">modelReinitNeeded (EmbeddedTypeHandler, EmbeddedTypeHandler): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/34)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1a">modelReinitNeeded (String, String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/28)</TD><TD CLASS="h">0%   (0/8)</TD></TR><TR><TD CLASS="f"><A HREF="#1b">notifyChanged (INodeNotifier, int, Object, Object, Object, int): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1c">release (): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/26)</TD><TD CLASS="h">0%   (0/9)</TD></TR><TR><TD CLASS="f"><A HREF="#1d">setCachedContentType (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/63)</TD><TD CLASS="h">0%   (0/19)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1e">setCachedLanguage (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/22)</TD><TD CLASS="h">0%   (0/5)</TD></TR><TR><TD CLASS="f"><A HREF="#1f">setEmbeddedType (EmbeddedTypeHandler): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/50)</TD><TD CLASS="h">0%   (0/15)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#20">setLanguage (String): void</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/18)</TD><TD CLASS="h">0%   (0/5)</TD></TR></TABLE><P></P><TABLE CLASS="s" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="l">1</TD><TD>/*******************************************************************************</TD></TR><TR><TD CLASS="l">2</TD><TD> * Copyright (c) 2004, 2007 IBM Corporation and others.</TD></TR><TR><TD CLASS="l">3</TD><TD> * All rights reserved. This program and the accompanying materials</TD></TR><TR><TD CLASS="l">4</TD><TD> * are made available under the terms of the Eclipse Public License v1.0</TD></TR><TR><TD CLASS="l">5</TD><TD> * which accompanies this distribution, and is available at</TD></TR><TR><TD CLASS="l">6</TD><TD> * http://www.eclipse.org/legal/epl-v10.html</TD></TR><TR><TD CLASS="l">7</TD><TD> * </TD></TR><TR><TD CLASS="l">8</TD><TD> * Contributors:</TD></TR><TR><TD CLASS="l">9</TD><TD> *     IBM Corporation - initial API and implementation</TD></TR><TR><TD CLASS="l">10</TD><TD> *******************************************************************************/</TD></TR><TR><TD CLASS="l">11</TD><TD>package org.eclipse.jst.jsp.core.internal.document;</TD></TR><TR><TD CLASS="l">12</TD><TD> </TD></TR><TR><TD CLASS="l">13</TD><TD>import java.io.IOException;</TD></TR><TR><TD CLASS="l">14</TD><TD>import java.io.Reader;</TD></TR><TR><TD CLASS="l">15</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">16</TD><TD>import java.util.Iterator;</TD></TR><TR><TD CLASS="l">17</TD><TD>import java.util.List;</TD></TR><TR><TD CLASS="l">18</TD><TD> </TD></TR><TR><TD CLASS="l">19</TD><TD>import org.eclipse.core.resources.IFile;</TD></TR><TR><TD CLASS="l">20</TD><TD>import org.eclipse.core.resources.ResourcesPlugin;</TD></TR><TR><TD CLASS="l">21</TD><TD>import org.eclipse.core.runtime.IPath;</TD></TR><TR><TD CLASS="l">22</TD><TD>import org.eclipse.core.runtime.Path;</TD></TR><TR><TD CLASS="l">23</TD><TD>import org.eclipse.core.runtime.Platform;</TD></TR><TR><TD CLASS="l">24</TD><TD>import org.eclipse.core.runtime.content.IContentDescription;</TD></TR><TR><TD CLASS="l">25</TD><TD>import org.eclipse.core.runtime.content.IContentType;</TD></TR><TR><TD CLASS="l">26</TD><TD>import org.eclipse.jface.text.IDocument;</TD></TR><TR><TD CLASS="l">27</TD><TD>import org.eclipse.jface.text.IDocumentExtension3;</TD></TR><TR><TD CLASS="l">28</TD><TD>import org.eclipse.jface.text.IDocumentPartitioner;</TD></TR><TR><TD CLASS="l">29</TD><TD>import org.eclipse.jst.jsp.core.internal.Logger;</TD></TR><TR><TD CLASS="l">30</TD><TD>import org.eclipse.jst.jsp.core.internal.contentproperties.JSPFContentProperties;</TD></TR><TR><TD CLASS="l">31</TD><TD>import org.eclipse.jst.jsp.core.internal.modelhandler.EmbeddedTypeStateData;</TD></TR><TR><TD CLASS="l">32</TD><TD>import org.eclipse.jst.jsp.core.internal.provisional.contenttype.ContentTypeIdForJSP;</TD></TR><TR><TD CLASS="l">33</TD><TD>import org.eclipse.jst.jsp.core.internal.provisional.contenttype.IContentDescriptionForJSP;</TD></TR><TR><TD CLASS="l">34</TD><TD>import org.eclipse.jst.jsp.core.internal.text.StructuredTextPartitionerForJSP;</TD></TR><TR><TD CLASS="l">35</TD><TD>import org.eclipse.wst.html.core.internal.provisional.contenttype.ContentTypeFamilyForHTML;</TD></TR><TR><TD CLASS="l">36</TD><TD>import org.eclipse.wst.sse.core.internal.document.DocumentReader;</TD></TR><TR><TD CLASS="l">37</TD><TD>import org.eclipse.wst.sse.core.internal.ltk.modelhandler.EmbeddedTypeHandler;</TD></TR><TR><TD CLASS="l">38</TD><TD>import org.eclipse.wst.sse.core.internal.modelhandler.EmbeddedTypeRegistry;</TD></TR><TR><TD CLASS="l">39</TD><TD>import org.eclipse.wst.sse.core.internal.modelhandler.EmbeddedTypeRegistryImpl;</TD></TR><TR><TD CLASS="l">40</TD><TD>import org.eclipse.wst.sse.core.internal.provisional.INodeAdapter;</TD></TR><TR><TD CLASS="l">41</TD><TD>import org.eclipse.wst.sse.core.internal.provisional.INodeAdapterFactory;</TD></TR><TR><TD CLASS="l">42</TD><TD>import org.eclipse.wst.sse.core.internal.provisional.INodeNotifier;</TD></TR><TR><TD CLASS="l">43</TD><TD>import org.eclipse.wst.sse.core.internal.provisional.IStructuredModel;</TD></TR><TR><TD CLASS="l">44</TD><TD>import org.eclipse.wst.sse.core.internal.provisional.text.IStructuredPartitioning;</TD></TR><TR><TD CLASS="l">45</TD><TD>import org.eclipse.wst.sse.core.internal.util.Debug;</TD></TR><TR><TD CLASS="l">46</TD><TD>import org.eclipse.wst.sse.core.utils.StringUtils;</TD></TR><TR><TD CLASS="l">47</TD><TD>import org.eclipse.wst.xml.core.internal.provisional.document.IDOMNode;</TD></TR><TR><TD CLASS="l">48</TD><TD> </TD></TR><TR><TD CLASS="l">49</TD><TD>import com.ibm.icu.util.StringTokenizer;</TD></TR><TR><TD CLASS="l">50</TD><TD> </TD></TR><TR><TD CLASS="l">51</TD><TD>/**</TD></TR><TR><TD CLASS="l">52</TD><TD> * This class has the responsibility to provide an embedded factory registry</TD></TR><TR><TD CLASS="l">53</TD><TD> * for JSP Aware INodeAdapter Factories to use.</TD></TR><TR><TD CLASS="l">54</TD><TD> * </TD></TR><TR><TD CLASS="l">55</TD><TD> * Typically, the embedded type is to be considered a feature of the document,</TD></TR><TR><TD CLASS="l">56</TD><TD> * so JSP Aware AdpaterFactories should call</TD></TR><TR><TD CLASS="l">57</TD><TD> * getAdapter(PageDirectiveAdapter.class) directoy on the document (or owning</TD></TR><TR><TD CLASS="l">58</TD><TD> * document) node.</TD></TR><TR><TD CLASS="l"><A NAME="0">59</A></TD><TD> */</TD></TR><TR CLASS="z"><TD CLASS="l">60</TD><TD>public class PageDirectiveAdapterImpl implements PageDirectiveAdapter {</TD></TR><TR><TD CLASS="l">61</TD><TD> </TD></TR><TR><TD CLASS="l">62</TD><TD>        protected static final String STR_CHARSET = &#34;charset&#34;; //$NON-NLS-1$</TD></TR><TR CLASS="z"><TD CLASS="l">63</TD><TD>        private final static Object adapterType = PageDirectiveAdapter.class;</TD></TR><TR><TD CLASS="l">64</TD><TD>        private IStructuredModel model;</TD></TR><TR CLASS="z"><TD CLASS="l">65</TD><TD>        protected final String[] JAVASCRIPT_LANGUAGE_KEYS = new String[]{&#34;javascript&#34;, &#34;javascript1.0&#34;, &#34;javascript1.1_3&#34;, &#34;javascript1.2&#34;, &#34;javascript1.3&#34;, &#34;javascript1.4&#34;, &#34;javascript1.5&#34;, &#34;javascript1.6&#34;, &#34;jscript&#34;, &#34;sashscript&#34;}; //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$ //$NON-NLS-4$ //$NON-NLS-5$ //$NON-NLS-6$ //$NON-NLS-7$ //$NON-NLS-8$ //$NON-NLS-9$ //$NON-NLS-10$</TD></TR><TR CLASS="z"><TD CLASS="l">66</TD><TD>        protected final String[] JAVA_LANGUAGE_KEYS = new String[]{&#34;java&#34;}; //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">67</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="2">68</A></TD><TD>        /**</TD></TR><TR><TD CLASS="l">69</TD><TD>         * Constructor for PageDirectiveAdapterImpl.</TD></TR><TR><TD CLASS="l">70</TD><TD>         */</TD></TR><TR><TD CLASS="l">71</TD><TD>        public PageDirectiveAdapterImpl(INodeNotifier target) {</TD></TR><TR CLASS="z"><TD CLASS="l">72</TD><TD>                super();</TD></TR><TR CLASS="z"><TD CLASS="l">73</TD><TD>                notifierAtCreation = target;</TD></TR><TR><TD CLASS="l">74</TD><TD>                // we need to remember our instance of model,</TD></TR><TR><TD CLASS="l">75</TD><TD>                // in case we need to &#34;signal&#34; a re-init needed.</TD></TR><TR CLASS="z"><TD CLASS="l">76</TD><TD>                if (target instanceof IDOMNode) {</TD></TR><TR CLASS="z"><TD CLASS="l">77</TD><TD>                        IDOMNode node = (IDOMNode) target;</TD></TR><TR CLASS="z"><TD CLASS="l">78</TD><TD>                        model = node.getModel();</TD></TR><TR><TD CLASS="l">79</TD><TD>                }</TD></TR><TR><TD CLASS="l">80</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">81</TD><TD>        }</TD></TR><TR><TD CLASS="l">82</TD><TD> </TD></TR><TR><TD CLASS="l">83</TD><TD>        /**</TD></TR><TR><TD CLASS="l">84</TD><TD>         * parses the full contentType value into its two parts the contentType,</TD></TR><TR><TD CLASS="l">85</TD><TD>         * and the charset, if present. Note: this method is a lightly modified</TD></TR><TR><TD CLASS="l">86</TD><TD>         * version of a method in AbstractHeadParser. There, we're mostly</TD></TR><TR><TD CLASS="l"><A NAME="13">87</A></TD><TD>         * interested in the charset part of contentTypeValue. Here, we're mostly</TD></TR><TR><TD CLASS="l">88</TD><TD>         * interested in the mimeType part.</TD></TR><TR><TD CLASS="l">89</TD><TD>         */</TD></TR><TR><TD CLASS="l">90</TD><TD>        private String getMimeTypeFromContentTypeValue(String contentTypeValue) {</TD></TR><TR CLASS="z"><TD CLASS="l">91</TD><TD>                if (contentTypeValue == null)</TD></TR><TR CLASS="z"><TD CLASS="l">92</TD><TD>                        return null;</TD></TR><TR CLASS="z"><TD CLASS="l">93</TD><TD>                String cleanContentTypeValue = StringUtils.stripNonLetterDigits(contentTypeValue);</TD></TR><TR CLASS="z"><TD CLASS="l">94</TD><TD>                StringTokenizer tokenizer = new StringTokenizer(cleanContentTypeValue, &#34;;= \t\n\r\f&#34;); //$NON-NLS-1$</TD></TR><TR CLASS="z"><TD CLASS="l">95</TD><TD>                int tLen = tokenizer.countTokens();</TD></TR><TR><TD CLASS="l">96</TD><TD>                // if contains encoding should have three tokens, the mimetype, the</TD></TR><TR><TD CLASS="l">97</TD><TD>                // word 'charset', and the encoding value</TD></TR><TR CLASS="z"><TD CLASS="l">98</TD><TD>                String[] tokens = new String[tLen];</TD></TR><TR CLASS="z"><TD CLASS="l">99</TD><TD>                int j = 0;</TD></TR><TR CLASS="z"><TD CLASS="l">100</TD><TD>                while (tokenizer.hasMoreTokens()) {</TD></TR><TR CLASS="z"><TD CLASS="l">101</TD><TD>                        tokens[j] = tokenizer.nextToken();</TD></TR><TR CLASS="z"><TD CLASS="l">102</TD><TD>                        j++;</TD></TR><TR><TD CLASS="l">103</TD><TD>                }</TD></TR><TR><TD CLASS="l">104</TD><TD>                // </TD></TR><TR><TD CLASS="l">105</TD><TD>                // Following is the common form for target expression</TD></TR><TR><TD CLASS="l">106</TD><TD>                // &lt;META http-equiv=&#34;Content-Type&#34; content=&#34;text/html; charset=UTF-8&#34;&gt;</TD></TR><TR><TD CLASS="l">107</TD><TD>                // But apparrently is also valid without the content type there,</TD></TR><TR><TD CLASS="l">108</TD><TD>                // just the charset, as follows:</TD></TR><TR><TD CLASS="l">109</TD><TD>                // &lt;META http-equiv=&#34;Content-Type&#34; content=&#34;charset=UTF-8&#34;&gt;</TD></TR><TR><TD CLASS="l">110</TD><TD>                // So we'll loop through tokens and key off of 'charset'</TD></TR><TR><TD CLASS="l">111</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">112</TD><TD>                int charsetPos = -1;</TD></TR><TR CLASS="z"><TD CLASS="l">113</TD><TD>                for (int i = 0; i &lt; tokens.length; i++) {</TD></TR><TR CLASS="z"><TD CLASS="l">114</TD><TD>                        if (tokens[i].equalsIgnoreCase(STR_CHARSET)) {</TD></TR><TR CLASS="z"><TD CLASS="l">115</TD><TD>                                charsetPos = i;</TD></TR><TR CLASS="z"><TD CLASS="l">116</TD><TD>                                break;</TD></TR><TR><TD CLASS="l">117</TD><TD>                        }</TD></TR><TR><TD CLASS="l">118</TD><TD>                }</TD></TR><TR><TD CLASS="l">119</TD><TD>                // String charset = null;</TD></TR><TR CLASS="z"><TD CLASS="l">120</TD><TD>                String contentType = null;</TD></TR><TR CLASS="z"><TD CLASS="l">121</TD><TD>                if (charsetPos &gt; -1) {</TD></TR><TR><TD CLASS="l">122</TD><TD>                        // case where charset was present</TD></TR><TR><TD CLASS="l">123</TD><TD>                        // int charsetValuePos = charsetPos + 1;</TD></TR><TR><TD CLASS="l">124</TD><TD>                        // if (charsetValuePos &lt; tokens.length) {</TD></TR><TR><TD CLASS="l">125</TD><TD>                        // charset = tokens[charsetValuePos];</TD></TR><TR><TD CLASS="l">126</TD><TD>                        // }</TD></TR><TR CLASS="z"><TD CLASS="l">127</TD><TD>                        int contentTypeValuePos = charsetPos - 1;</TD></TR><TR CLASS="z"><TD CLASS="l">128</TD><TD>                        if (contentTypeValuePos &gt; -1) {</TD></TR><TR CLASS="z"><TD CLASS="l">129</TD><TD>                                contentType = tokens[contentTypeValuePos];</TD></TR><TR><TD CLASS="l">130</TD><TD>                        }</TD></TR><TR><TD CLASS="l">131</TD><TD>                }</TD></TR><TR><TD CLASS="l">132</TD><TD>                else {</TD></TR><TR><TD CLASS="l">133</TD><TD>                        // charset was not present, so if there's</TD></TR><TR><TD CLASS="l">134</TD><TD>                        // a value, we assume its the contentType value</TD></TR><TR CLASS="z"><TD CLASS="l">135</TD><TD>                        if (tokens.length &gt; 0) {</TD></TR><TR CLASS="z"><TD CLASS="l">136</TD><TD>                                contentType = tokens[0];</TD></TR><TR><TD CLASS="l">137</TD><TD>                        }</TD></TR><TR><TD CLASS="l">138</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">139</TD><TD>                return contentType;</TD></TR><TR><TD CLASS="l">140</TD><TD>        }</TD></TR><TR><TD CLASS="l">141</TD><TD> </TD></TR><TR><TD CLASS="l">142</TD><TD>        private EmbeddedTypeHandler embeddedTypeHandler;</TD></TR><TR CLASS="z"><TD CLASS="l">143</TD><TD>        private List embeddedFactoryRegistry = new ArrayList();</TD></TR><TR><TD CLASS="l">144</TD><TD>        private String cachedLanguage;</TD></TR><TR><TD CLASS="l">145</TD><TD>        private String cachedContentType;</TD></TR><TR><TD CLASS="l">146</TD><TD>        private INodeNotifier notifierAtCreation;</TD></TR><TR><TD CLASS="l">147</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">148</TD><TD>        private int firstLanguagePosition = -1;</TD></TR><TR CLASS="z"><TD CLASS="l">149</TD><TD>        private int firstContentTypePosition = -1;</TD></TR><TR><TD CLASS="l">150</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="16">151</A></TD><TD>        /*</TD></TR><TR><TD CLASS="l">152</TD><TD>         * @see INodeAdapter#isAdapterForType(Object)</TD></TR><TR><TD CLASS="l">153</TD><TD>         */</TD></TR><TR><TD CLASS="l">154</TD><TD>        public boolean isAdapterForType(Object type) {</TD></TR><TR CLASS="z"><TD CLASS="l">155</TD><TD>                return (type == adapterType);</TD></TR><TR><TD CLASS="l">156</TD><TD>        }</TD></TR><TR><TD CLASS="l">157</TD><TD> </TD></TR><TR><TD CLASS="l">158</TD><TD>        /*</TD></TR><TR><TD CLASS="l"><A NAME="1b">159</A></TD><TD>         * @see INodeAdapter#notifyChanged(INodeNotifier, int, Object, Object,</TD></TR><TR><TD CLASS="l">160</TD><TD>         *      Object, int)</TD></TR><TR><TD CLASS="l">161</TD><TD>         */</TD></TR><TR><TD CLASS="l">162</TD><TD>        public void notifyChanged(INodeNotifier notifier, int eventType, Object changedFeature, Object oldValue, Object newValue, int pos) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1f">163</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">164</TD><TD> </TD></TR><TR><TD CLASS="l">165</TD><TD>        public void setEmbeddedType(EmbeddedTypeHandler handler) {</TD></TR><TR><TD CLASS="l">166</TD><TD>                // if really the same handler, no need for further processing</TD></TR><TR CLASS="z"><TD CLASS="l">167</TD><TD>                if (embeddedTypeHandler == handler) {</TD></TR><TR CLASS="z"><TD CLASS="l">168</TD><TD>                        return;</TD></TR><TR><TD CLASS="l">169</TD><TD>                }</TD></TR><TR><TD CLASS="l">170</TD><TD>                // then one exists, and the new one is truely different, so we need to</TD></TR><TR><TD CLASS="l">171</TD><TD>                // release and remove current factories</TD></TR><TR CLASS="z"><TD CLASS="l">172</TD><TD>                if (embeddedTypeHandler != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">173</TD><TD>                        Iterator list = embeddedFactoryRegistry.iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">174</TD><TD>                        while (list.hasNext()) {</TD></TR><TR CLASS="z"><TD CLASS="l">175</TD><TD>                                INodeAdapterFactory factory = (INodeAdapterFactory) list.next();</TD></TR><TR CLASS="z"><TD CLASS="l">176</TD><TD>                                factory.release();</TD></TR><TR><TD CLASS="l">177</TD><TD>                        }</TD></TR><TR><TD CLASS="l">178</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">179</TD><TD>                        embeddedFactoryRegistry.clear();</TD></TR><TR><TD CLASS="l">180</TD><TD>                }</TD></TR><TR><TD CLASS="l">181</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">182</TD><TD>                embeddedTypeHandler = handler;</TD></TR><TR><TD CLASS="l">183</TD><TD>                // when the handler is set, &#34;transfer&#34; its factories to our own list.</TD></TR><TR><TD CLASS="l">184</TD><TD>                // note: our own list may also be added to else where, such as on</TD></TR><TR><TD CLASS="l">185</TD><TD>                // &#34;editor side&#34;.</TD></TR><TR CLASS="z"><TD CLASS="l">186</TD><TD>                if (embeddedTypeHandler != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">187</TD><TD>                        Iterator iterator = embeddedTypeHandler.getAdapterFactories().iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">188</TD><TD>                        while (iterator.hasNext()) {</TD></TR><TR CLASS="z"><TD CLASS="l">189</TD><TD>                                INodeAdapterFactory factory = (INodeAdapterFactory) iterator.next();</TD></TR><TR CLASS="z"><TD CLASS="l">190</TD><TD>                                embeddedFactoryRegistry.add(factory);</TD></TR><TR><TD CLASS="l">191</TD><TD>                        }</TD></TR><TR><TD CLASS="l">192</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">193</TD><TD>        }</TD></TR><TR><TD CLASS="l">194</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="3">195</A></TD><TD>        /**</TD></TR><TR><TD CLASS="l">196</TD><TD>         * @see PageDirectiveAdapter#adapt(INodeNotifier, Object)</TD></TR><TR><TD CLASS="l">197</TD><TD>         */</TD></TR><TR><TD CLASS="l">198</TD><TD>        public INodeAdapter adapt(INodeNotifier notifier, Object type) {</TD></TR><TR CLASS="z"><TD CLASS="l">199</TD><TD>                INodeAdapter result = null;</TD></TR><TR><TD CLASS="l">200</TD><TD>                // if embeddedContentType hasn't been set,</TD></TR><TR><TD CLASS="l">201</TD><TD>                // then we can not adapt it.</TD></TR><TR CLASS="z"><TD CLASS="l">202</TD><TD>                if (embeddedTypeHandler != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">203</TD><TD>                        if (embeddedFactoryRegistry != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">204</TD><TD>                                Iterator iterator = embeddedFactoryRegistry.iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">205</TD><TD>                                INodeAdapterFactory factory = null;</TD></TR><TR CLASS="z"><TD CLASS="l">206</TD><TD>                                while (iterator.hasNext()) {</TD></TR><TR CLASS="z"><TD CLASS="l">207</TD><TD>                                        factory = (INodeAdapterFactory) iterator.next();</TD></TR><TR CLASS="z"><TD CLASS="l">208</TD><TD>                                        if (factory.isFactoryForType(type)) {</TD></TR><TR CLASS="z"><TD CLASS="l">209</TD><TD>                                                result = factory.adapt(notifier);</TD></TR><TR CLASS="z"><TD CLASS="l">210</TD><TD>                                                break;</TD></TR><TR><TD CLASS="l">211</TD><TD>                                        }</TD></TR><TR><TD CLASS="l">212</TD><TD>                                }</TD></TR><TR><TD CLASS="l">213</TD><TD>                        }</TD></TR><TR><TD CLASS="l">214</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">215</TD><TD>                return result;</TD></TR><TR><TD CLASS="l">216</TD><TD> </TD></TR><TR><TD CLASS="l">217</TD><TD>        }</TD></TR><TR><TD CLASS="l">218</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="f">219</A></TD><TD>        /**</TD></TR><TR><TD CLASS="l">220</TD><TD>         * @see PageDirectiveAdapter#getEmbeddedType()</TD></TR><TR><TD CLASS="l">221</TD><TD>         */</TD></TR><TR><TD CLASS="l">222</TD><TD>        public EmbeddedTypeHandler getEmbeddedType() {</TD></TR><TR CLASS="z"><TD CLASS="l">223</TD><TD>                if (embeddedTypeHandler == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">224</TD><TD>                        embeddedTypeHandler = getDefaultEmbeddedType();</TD></TR><TR><TD CLASS="l">225</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">226</TD><TD>                return embeddedTypeHandler;</TD></TR><TR><TD CLASS="l"><A NAME="4">227</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">228</TD><TD> </TD></TR><TR><TD CLASS="l">229</TD><TD>        public void addEmbeddedFactory(INodeAdapterFactory factory) {</TD></TR><TR><TD CLASS="l">230</TD><TD>                // should we check if already exists in list?</TD></TR><TR CLASS="z"><TD CLASS="l">231</TD><TD>                embeddedFactoryRegistry.add(factory);</TD></TR><TR CLASS="z"><TD CLASS="l">232</TD><TD>        }</TD></TR><TR><TD CLASS="l">233</TD><TD> </TD></TR><TR><TD CLASS="l">234</TD><TD>        // /**</TD></TR><TR><TD CLASS="l">235</TD><TD>        // * Used by PageDirectiveWatchers to signal that some important attribute</TD></TR><TR><TD CLASS="l">236</TD><TD>        // has changed, and</TD></TR><TR><TD CLASS="l">237</TD><TD>        // * any cached values should be re-calcuated</TD></TR><TR><TD CLASS="l">238</TD><TD>        // */</TD></TR><TR><TD CLASS="l">239</TD><TD>        // void changed() {</TD></TR><TR><TD CLASS="l">240</TD><TD>        // // we won't actually check if change is needed, if the model state is</TD></TR><TR><TD CLASS="l">241</TD><TD>        // already changing.</TD></TR><TR><TD CLASS="l">242</TD><TD>        // if (!model.isReinitializationNeeded()) {</TD></TR><TR><TD CLASS="l">243</TD><TD>        // // go through our list of page watcher adapters, and updates the</TD></TR><TR><TD CLASS="l">244</TD><TD>        // attributes</TD></TR><TR><TD CLASS="l">245</TD><TD>        // // we're interested in, if and only if they are the earliest occurance</TD></TR><TR><TD CLASS="l">246</TD><TD>        // in the resource</TD></TR><TR><TD CLASS="l">247</TD><TD>        // String potentialContentType = null;</TD></TR><TR><TD CLASS="l">248</TD><TD>        // String potentialLanguage = null;</TD></TR><TR><TD CLASS="l">249</TD><TD>        // int contentTypePosition = -1;</TD></TR><TR><TD CLASS="l">250</TD><TD>        // int languagePosition = -1;</TD></TR><TR><TD CLASS="l">251</TD><TD>        // Iterator iterator = pageDirectiveWatchers.iterator();</TD></TR><TR><TD CLASS="l">252</TD><TD>        // while (iterator.hasNext()) {</TD></TR><TR><TD CLASS="l">253</TD><TD>        // PageDirectiveWatcher pdWatcher = (PageDirectiveWatcher)</TD></TR><TR><TD CLASS="l">254</TD><TD>        // iterator.next();</TD></TR><TR><TD CLASS="l">255</TD><TD>        // String contentType = pdWatcher.getContentType();</TD></TR><TR><TD CLASS="l">256</TD><TD>        // String language = pdWatcher.getLanguage();</TD></TR><TR><TD CLASS="l">257</TD><TD>        // int offset = pdWatcher.getOffset();</TD></TR><TR><TD CLASS="l">258</TD><TD>        // if (potentialContentType == null || (hasValue(contentType) &amp;&amp; (offset &lt;</TD></TR><TR><TD CLASS="l">259</TD><TD>        // contentTypePosition))) {</TD></TR><TR><TD CLASS="l">260</TD><TD>        // potentialContentType = contentType;</TD></TR><TR><TD CLASS="l">261</TD><TD>        // contentTypePosition = offset;</TD></TR><TR><TD CLASS="l">262</TD><TD>        // }</TD></TR><TR><TD CLASS="l">263</TD><TD>        // }</TD></TR><TR><TD CLASS="l">264</TD><TD>        // // now we have the best candiates for cached values, let's see if</TD></TR><TR><TD CLASS="l">265</TD><TD>        // they've really changed from</TD></TR><TR><TD CLASS="l">266</TD><TD>        // // what we had. If so, note we go through the setters so side effects</TD></TR><TR><TD CLASS="l">267</TD><TD>        // can take place there.</TD></TR><TR><TD CLASS="l">268</TD><TD>        // potentialContentType =</TD></TR><TR><TD CLASS="l">269</TD><TD>        // getMimeTypeFromContentTypeValue(potentialContentType);</TD></TR><TR><TD CLASS="l">270</TD><TD>        // if (potentialContentType == null || potentialContentType.length() == 0)</TD></TR><TR><TD CLASS="l">271</TD><TD>        // {</TD></TR><TR><TD CLASS="l">272</TD><TD>        // //potentialContentType = getDefaultContentType();</TD></TR><TR><TD CLASS="l">273</TD><TD>        // } else {</TD></TR><TR><TD CLASS="l">274</TD><TD>        // setCachedContentType(potentialContentType);</TD></TR><TR><TD CLASS="l">275</TD><TD>        // }</TD></TR><TR><TD CLASS="l">276</TD><TD>        //</TD></TR><TR><TD CLASS="l">277</TD><TD>        // if (potentialLanguage != null &amp;&amp; hasValue(potentialLanguage)) {</TD></TR><TR><TD CLASS="l">278</TD><TD>        // setCachedLanguage(potentialLanguage);</TD></TR><TR><TD CLASS="l">279</TD><TD>        // }</TD></TR><TR><TD CLASS="l">280</TD><TD>        // }</TD></TR><TR><TD CLASS="l"><A NAME="5">281</A></TD><TD>        // }</TD></TR><TR><TD CLASS="l">282</TD><TD>        void changedContentType(int elementOffset, String newValue) {</TD></TR><TR><TD CLASS="l">283</TD><TD>                // only need to process if this new value is</TD></TR><TR><TD CLASS="l">284</TD><TD>                // earlier in the file than our current value</TD></TR><TR CLASS="z"><TD CLASS="l">285</TD><TD>                if (firstContentTypePosition == -1 || elementOffset &lt;= firstContentTypePosition) {</TD></TR><TR><TD CLASS="l">286</TD><TD>                        // dw_TODO: update embedded partitioner in JSP document</TD></TR><TR><TD CLASS="l">287</TD><TD>                        // partitioner</TD></TR><TR><TD CLASS="l">288</TD><TD>                        // nsd_TODO: update embedded partitioner in JSP document</TD></TR><TR><TD CLASS="l">289</TD><TD>                        // partitioner</TD></TR><TR><TD CLASS="l">290</TD><TD> </TD></TR><TR><TD CLASS="l">291</TD><TD>                        // no need to change current value, if we're told some</TD></TR><TR><TD CLASS="l">292</TD><TD>                        // earlier value is null or blank (sounds like an error, anyway)</TD></TR><TR CLASS="z"><TD CLASS="l">293</TD><TD>                        if (hasValue(newValue)) {</TD></TR><TR CLASS="z"><TD CLASS="l">294</TD><TD>                                firstContentTypePosition = elementOffset;</TD></TR><TR CLASS="z"><TD CLASS="l">295</TD><TD>                                String potentialContentType = getMimeTypeFromContentTypeValue(newValue);</TD></TR><TR><TD CLASS="l">296</TD><TD>                                // only do the set processing if different</TD></TR><TR><TD CLASS="l">297</TD><TD>                                // from what it already is</TD></TR><TR><TD CLASS="l">298</TD><TD>                                // if (!potentialContentType.equalsIgnoreCase(cachedLanguage))</TD></TR><TR><TD CLASS="l">299</TD><TD>                                // {</TD></TR><TR CLASS="z"><TD CLASS="l">300</TD><TD>                                setCachedContentType(potentialContentType);</TD></TR><TR><TD CLASS="l">301</TD><TD>                                // }</TD></TR><TR><TD CLASS="l">302</TD><TD>                        }</TD></TR><TR><TD CLASS="l">303</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">304</TD><TD>        }</TD></TR><TR><TD CLASS="l">305</TD><TD> </TD></TR><TR><TD CLASS="l">306</TD><TD>        /**</TD></TR><TR><TD CLASS="l">307</TD><TD>         * Used by PageDirectiveWatchers to signal that some important attribute</TD></TR><TR><TD CLASS="l">308</TD><TD>         * has changed, and any cached values should be re-calcuated</TD></TR><TR><TD CLASS="l">309</TD><TD>         */</TD></TR><TR><TD CLASS="l">310</TD><TD>        void changedLanguage(int elementOffset, String newValue) {</TD></TR><TR><TD CLASS="l"><A NAME="6">311</A></TD><TD>                // only need to process if this new value is</TD></TR><TR><TD CLASS="l">312</TD><TD>                // earlier in the file than our current value</TD></TR><TR><TD CLASS="l">313</TD><TD>                // has to be less than or equal to, in case our previous earliest one,</TD></TR><TR><TD CLASS="l">314</TD><TD>                // is itself changing!</TD></TR><TR CLASS="z"><TD CLASS="l">315</TD><TD>                if (firstLanguagePosition == -1 || elementOffset &lt;= firstLanguagePosition) {</TD></TR><TR><TD CLASS="l">316</TD><TD> </TD></TR><TR><TD CLASS="l">317</TD><TD>                        // no need to change current value, if we're told some</TD></TR><TR><TD CLASS="l">318</TD><TD>                        // earlier value is null or blank (sounds like an error, anyway)</TD></TR><TR CLASS="z"><TD CLASS="l">319</TD><TD>                        if (hasValue(newValue)) {</TD></TR><TR CLASS="z"><TD CLASS="l">320</TD><TD>                                firstLanguagePosition = elementOffset;</TD></TR><TR><TD CLASS="l">321</TD><TD>                                // only do the set processing if different</TD></TR><TR><TD CLASS="l">322</TD><TD>                                // from what it already is</TD></TR><TR CLASS="z"><TD CLASS="l">323</TD><TD>                                if (!newValue.equalsIgnoreCase(cachedLanguage)) {</TD></TR><TR CLASS="z"><TD CLASS="l">324</TD><TD>                                        setCachedLanguage(newValue);</TD></TR><TR><TD CLASS="l">325</TD><TD>                                }</TD></TR><TR><TD CLASS="l">326</TD><TD>                        }</TD></TR><TR><TD CLASS="l">327</TD><TD> </TD></TR><TR><TD CLASS="l">328</TD><TD>                        // dw_TODO: set language in document partitioner</TD></TR><TR><TD CLASS="l">329</TD><TD>                        // nsd_TODO: set language in document partitioner</TD></TR><TR><TD CLASS="l">330</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">331</TD><TD>        }</TD></TR><TR><TD CLASS="l">332</TD><TD> </TD></TR><TR><TD CLASS="l">333</TD><TD>        /**</TD></TR><TR><TD CLASS="l">334</TD><TD>         * Used by PageDirectiveWatchers to signal that some important attribute</TD></TR><TR><TD CLASS="l">335</TD><TD>         * has changed, and any cached values should be re-calcuated</TD></TR><TR><TD CLASS="l">336</TD><TD>         */</TD></TR><TR><TD CLASS="l">337</TD><TD>        void changedPageEncoding(int elementOffset, String newValue) {</TD></TR><TR><TD CLASS="l">338</TD><TD> </TD></TR><TR><TD CLASS="l">339</TD><TD>                // we don't currently track active value, since</TD></TR><TR><TD CLASS="l"><A NAME="7">340</A></TD><TD>                // just need during read and write (where its</TD></TR><TR><TD CLASS="l">341</TD><TD>                // calculated. We will need in future, to</TD></TR><TR><TD CLASS="l">342</TD><TD>                // acurately clone a model and to display</TD></TR><TR><TD CLASS="l">343</TD><TD>                // &#34;current encoding&#34; to user in status bar.</TD></TR><TR CLASS="z"><TD CLASS="l">344</TD><TD>        }</TD></TR><TR><TD CLASS="l">345</TD><TD> </TD></TR><TR><TD CLASS="l">346</TD><TD>        /**</TD></TR><TR><TD CLASS="l">347</TD><TD>         * Method hasValue.</TD></TR><TR><TD CLASS="l">348</TD><TD>         * </TD></TR><TR><TD CLASS="l"><A NAME="15">349</A></TD><TD>         * @param contentType</TD></TR><TR><TD CLASS="l">350</TD><TD>         * @return boolean</TD></TR><TR><TD CLASS="l">351</TD><TD>         */</TD></TR><TR><TD CLASS="l">352</TD><TD>        private boolean hasValue(String value) {</TD></TR><TR CLASS="z"><TD CLASS="l">353</TD><TD>                if (value != null &amp;&amp; value.length() &gt; 0)</TD></TR><TR CLASS="z"><TD CLASS="l">354</TD><TD>                        return true;</TD></TR><TR><TD CLASS="l">355</TD><TD>                else</TD></TR><TR CLASS="z"><TD CLASS="l">356</TD><TD>                        return false;</TD></TR><TR><TD CLASS="l">357</TD><TD>        }</TD></TR><TR><TD CLASS="l">358</TD><TD> </TD></TR><TR><TD CLASS="l">359</TD><TD>        /**</TD></TR><TR><TD CLASS="l">360</TD><TD>         * Returns the cachedContentType.</TD></TR><TR><TD CLASS="l"><A NAME="a">361</A></TD><TD>         * </TD></TR><TR><TD CLASS="l">362</TD><TD>         * @return String</TD></TR><TR><TD CLASS="l">363</TD><TD>         */</TD></TR><TR><TD CLASS="l">364</TD><TD>        public String getContentType() {</TD></TR><TR CLASS="z"><TD CLASS="l">365</TD><TD>                if (cachedContentType == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">366</TD><TD>                        cachedContentType = getDefaultContentType();</TD></TR><TR><TD CLASS="l">367</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">368</TD><TD>                return cachedContentType;</TD></TR><TR><TD CLASS="l">369</TD><TD>        }</TD></TR><TR><TD CLASS="l">370</TD><TD> </TD></TR><TR><TD CLASS="l">371</TD><TD>        /**</TD></TR><TR><TD CLASS="l">372</TD><TD>         * Method getDefaultContentType.</TD></TR><TR><TD CLASS="l"><A NAME="b">373</A></TD><TD>         * </TD></TR><TR><TD CLASS="l">374</TD><TD>         * @return String</TD></TR><TR><TD CLASS="l">375</TD><TD>         */</TD></TR><TR><TD CLASS="l">376</TD><TD>        private String getDefaultContentType() {</TD></TR><TR CLASS="z"><TD CLASS="l">377</TD><TD>                String type = null;</TD></TR><TR CLASS="z"><TD CLASS="l">378</TD><TD>                IFile file = getFile(model);</TD></TR><TR CLASS="z"><TD CLASS="l">379</TD><TD>                if (file != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">380</TD><TD>                        type = JSPFContentProperties.getProperty(JSPFContentProperties.JSPCONTENTTYPE, file, true);</TD></TR><TR><TD CLASS="l">381</TD><TD>                }</TD></TR><TR><TD CLASS="l">382</TD><TD>                // BUG136468</TD></TR><TR CLASS="z"><TD CLASS="l">383</TD><TD>                if (type == null)</TD></TR><TR CLASS="z"><TD CLASS="l">384</TD><TD>                        type = &#34;text/html&#34;; //$NON-NLS-1$</TD></TR><TR CLASS="z"><TD CLASS="l">385</TD><TD>                return type;</TD></TR><TR><TD CLASS="l">386</TD><TD>        }</TD></TR><TR><TD CLASS="l">387</TD><TD> </TD></TR><TR><TD CLASS="l">388</TD><TD>        /**</TD></TR><TR><TD CLASS="l">389</TD><TD>         * Returns the cachedLanguage.</TD></TR><TR><TD CLASS="l"><A NAME="12">390</A></TD><TD>         * </TD></TR><TR><TD CLASS="l">391</TD><TD>         * @return String</TD></TR><TR><TD CLASS="l">392</TD><TD>         */</TD></TR><TR><TD CLASS="l">393</TD><TD>        public String getLanguage() {</TD></TR><TR CLASS="z"><TD CLASS="l">394</TD><TD>                if (cachedLanguage == null)</TD></TR><TR CLASS="z"><TD CLASS="l">395</TD><TD>                        cachedLanguage = getDefaultLanguage();</TD></TR><TR CLASS="z"><TD CLASS="l">396</TD><TD>                return cachedLanguage;</TD></TR><TR><TD CLASS="l">397</TD><TD>        }</TD></TR><TR><TD CLASS="l">398</TD><TD> </TD></TR><TR><TD CLASS="l">399</TD><TD>        /**</TD></TR><TR><TD CLASS="l">400</TD><TD>         * Method getDefaultLanguage.</TD></TR><TR><TD CLASS="l"><A NAME="d">401</A></TD><TD>         * </TD></TR><TR><TD CLASS="l">402</TD><TD>         * @return String</TD></TR><TR><TD CLASS="l">403</TD><TD>         */</TD></TR><TR><TD CLASS="l">404</TD><TD>        private String getDefaultLanguage() {</TD></TR><TR CLASS="z"><TD CLASS="l">405</TD><TD>                String language = null;</TD></TR><TR CLASS="z"><TD CLASS="l">406</TD><TD>                IFile file = getFile(model);</TD></TR><TR CLASS="z"><TD CLASS="l">407</TD><TD>                if (file != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">408</TD><TD>                        language = JSPFContentProperties.getProperty(JSPFContentProperties.JSPLANGUAGE, file, true);</TD></TR><TR><TD CLASS="l">409</TD><TD>                }</TD></TR><TR><TD CLASS="l">410</TD><TD>                // BUG136468</TD></TR><TR CLASS="z"><TD CLASS="l">411</TD><TD>                if (language == null)</TD></TR><TR CLASS="z"><TD CLASS="l">412</TD><TD>                        language = &#34;java&#34;; //$NON-NLS-1$</TD></TR><TR CLASS="z"><TD CLASS="l">413</TD><TD>                return language;</TD></TR><TR><TD CLASS="l">414</TD><TD>        }</TD></TR><TR><TD CLASS="l">415</TD><TD> </TD></TR><TR><TD CLASS="l">416</TD><TD>        /**</TD></TR><TR><TD CLASS="l">417</TD><TD>         * Sets the cachedContentType.</TD></TR><TR><TD CLASS="l">418</TD><TD>         * </TD></TR><TR><TD CLASS="l">419</TD><TD>         * @param cachedContentType</TD></TR><TR><TD CLASS="l">420</TD><TD>         *            The cachedContentType to set</TD></TR><TR><TD CLASS="l">421</TD><TD>         */</TD></TR><TR><TD CLASS="l">422</TD><TD>        public void setCachedContentType(String newContentType) {</TD></TR><TR><TD CLASS="l">423</TD><TD>                /*</TD></TR><TR><TD CLASS="l">424</TD><TD>                 * if the passed in value is the same as existing, there's nothing to</TD></TR><TR><TD CLASS="l">425</TD><TD>                 * do. if its different, then we need to change the contentHandler as</TD></TR><TR><TD CLASS="l">426</TD><TD>                 * well and, more to the point, signal a re-initializtation is needed.</TD></TR><TR><TD CLASS="l">427</TD><TD>                 * </TD></TR><TR><TD CLASS="l">428</TD><TD>                 * Note: if the value we're getting set to does not have a handler in</TD></TR><TR><TD CLASS="l">429</TD><TD>                 * the registry, we'll actually not set it to null or anything, we'll</TD></TR><TR><TD CLASS="l">430</TD><TD>                 * just continue on with the one we have. This is pretty important to</TD></TR><TR><TD CLASS="l">431</TD><TD>                 * avoid re-initializing on every key stroke if someone is typing in a</TD></TR><TR><TD CLASS="l">432</TD><TD>                 * new content type, but haven't yet finished the whole &#34;word&#34;.</TD></TR><TR><TD CLASS="l">433</TD><TD>                 * However, if an contentType is not recognized, the registry returns</TD></TR><TR><TD CLASS="l"><A NAME="1d">434</A></TD><TD>                 * the one for XML.</TD></TR><TR><TD CLASS="l">435</TD><TD>                 */</TD></TR><TR><TD CLASS="l">436</TD><TD>                </TD></TR><TR><TD CLASS="l">437</TD><TD>                /* set the actual value first, the rest is &#34;side effect&#34; */</TD></TR><TR CLASS="z"><TD CLASS="l">438</TD><TD>                this.cachedContentType = newContentType;</TD></TR><TR><TD CLASS="l">439</TD><TD> </TD></TR><TR><TD CLASS="l">440</TD><TD>                /* see if we need to update embedded handler */</TD></TR><TR><TD CLASS="l">441</TD><TD> </TD></TR><TR><TD CLASS="l">442</TD><TD>                /*</TD></TR><TR><TD CLASS="l">443</TD><TD>                 * If the document is a type of XHTML, we do not use the page</TD></TR><TR><TD CLASS="l">444</TD><TD>                 * directive's contentType to determine the embedded type ... its</TD></TR><TR><TD CLASS="l">445</TD><TD>                 * XHTML! ... and, eventually, the DOCTYPE adapter should determine</TD></TR><TR><TD CLASS="l">446</TD><TD>                 * if/when it needs to change.</TD></TR><TR><TD CLASS="l">447</TD><TD>                 */</TD></TR><TR><TD CLASS="l">448</TD><TD> </TD></TR><TR><TD CLASS="l">449</TD><TD>                /* just safety check, can be removed later, early in release cycle */</TD></TR><TR CLASS="z"><TD CLASS="l">450</TD><TD>                if (model == null) {</TD></TR><TR><TD CLASS="l">451</TD><TD>                        // throw IllegalStateException(&#34;model should never be null in</TD></TR><TR><TD CLASS="l">452</TD><TD>                        // PageDirective Adapter&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">453</TD><TD>                        Logger.log(Logger.ERROR, &#34;model should never be null in PageDirective Adapter&#34;);</TD></TR><TR CLASS="z"><TD CLASS="l">454</TD><TD>                        return;</TD></TR><TR><TD CLASS="l">455</TD><TD>                }</TD></TR><TR><TD CLASS="l">456</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">457</TD><TD>                EmbeddedTypeHandler potentialNewandler = null;</TD></TR><TR CLASS="z"><TD CLASS="l">458</TD><TD>                IContentDescription contentDescription = getContentDescription(model.getStructuredDocument());</TD></TR><TR CLASS="z"><TD CLASS="l">459</TD><TD>                Object prop = contentDescription.getProperty(IContentDescriptionForJSP.CONTENT_FAMILY_ATTRIBUTE);</TD></TR><TR CLASS="z"><TD CLASS="l">460</TD><TD>                if (prop != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">461</TD><TD>                        if (ContentTypeFamilyForHTML.HTML_FAMILY.equals(prop)) {</TD></TR><TR CLASS="z"><TD CLASS="l">462</TD><TD>                                potentialNewandler = EmbeddedTypeRegistryImpl.getInstance().getTypeFor(&#34;text/html&#34;);</TD></TR><TR><TD CLASS="l">463</TD><TD>                        }</TD></TR><TR><TD CLASS="l">464</TD><TD>                }</TD></TR><TR><TD CLASS="l">465</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">466</TD><TD>                if (potentialNewandler == null) {</TD></TR><TR><TD CLASS="l">467</TD><TD>                        /*</TD></TR><TR><TD CLASS="l">468</TD><TD>                         * getHandler should always return something (never null), based</TD></TR><TR><TD CLASS="l">469</TD><TD>                         * on the rules in the factory.</TD></TR><TR><TD CLASS="l">470</TD><TD>                         */</TD></TR><TR CLASS="z"><TD CLASS="l">471</TD><TD>                        potentialNewandler = getHandlerFor(this.cachedContentType);</TD></TR><TR><TD CLASS="l">472</TD><TD>                }</TD></TR><TR><TD CLASS="l">473</TD><TD>                /*</TD></TR><TR><TD CLASS="l">474</TD><TD>                 * we do this check for re-init here, instead of in setEmbeddedType,</TD></TR><TR><TD CLASS="l">475</TD><TD>                 * since setEmbeddedType is called during the normal initializtion</TD></TR><TR><TD CLASS="l">476</TD><TD>                 * process, when re-init is not needed (since there is no content)</TD></TR><TR><TD CLASS="l">477</TD><TD>                 */</TD></TR><TR CLASS="z"><TD CLASS="l">478</TD><TD>                if (embeddedTypeHandler == null) {</TD></TR><TR CLASS="z"><TD CLASS="l">479</TD><TD>                        setEmbeddedType(potentialNewandler);</TD></TR><TR><TD CLASS="l">480</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">481</TD><TD>                else if (potentialNewandler != null &amp;&amp; embeddedTypeHandler != potentialNewandler) {</TD></TR><TR><TD CLASS="l">482</TD><TD>                        /*</TD></TR><TR><TD CLASS="l">483</TD><TD>                         * changing this embedded handler here may be in the middle of a</TD></TR><TR><TD CLASS="l">484</TD><TD>                         * notify loop. That's why we set that &#34;it's needed&#34;. Then the</TD></TR><TR><TD CLASS="l">485</TD><TD>                         * model decides when its &#34;safe&#34; to actually do the re-init.</TD></TR><TR><TD CLASS="l">486</TD><TD>                         * </TD></TR><TR><TD CLASS="l">487</TD><TD>                         * be sure to hold oldHandler in temp var or else setEmbeddedType</TD></TR><TR><TD CLASS="l">488</TD><TD>                         * will &#34;reset&#34; it before modelReinitNeeded(oldHandler, handler)</TD></TR><TR><TD CLASS="l">489</TD><TD>                         * is called</TD></TR><TR><TD CLASS="l">490</TD><TD>                         * </TD></TR><TR><TD CLASS="l">491</TD><TD>                         */</TD></TR><TR CLASS="z"><TD CLASS="l">492</TD><TD>                        EmbeddedTypeHandler oldHandler = embeddedTypeHandler;</TD></TR><TR CLASS="z"><TD CLASS="l">493</TD><TD>                        setEmbeddedType(potentialNewandler);</TD></TR><TR CLASS="z"><TD CLASS="l">494</TD><TD>                        modelReinitNeeded(oldHandler, potentialNewandler);</TD></TR><TR><TD CLASS="l">495</TD><TD>                }</TD></TR><TR><TD CLASS="l">496</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">497</TD><TD>        }</TD></TR><TR><TD CLASS="l">498</TD><TD> </TD></TR><TR><TD CLASS="l">499</TD><TD>        /**</TD></TR><TR><TD CLASS="l">500</TD><TD>         * This method is used to re-init based on embeddedTypeHandler changing.</TD></TR><TR><TD CLASS="l"><A NAME="19">501</A></TD><TD>         * It is given priority over the language change, since there its more</TD></TR><TR><TD CLASS="l">502</TD><TD>         * important to have old and new handlers's in the stateData field.</TD></TR><TR><TD CLASS="l">503</TD><TD>         */</TD></TR><TR><TD CLASS="l">504</TD><TD>        private void modelReinitNeeded(EmbeddedTypeHandler oldHandler, EmbeddedTypeHandler newHandler) {</TD></TR><TR CLASS="z"><TD CLASS="l">505</TD><TD>                if (model.isReinitializationNeeded()) {</TD></TR><TR CLASS="z"><TD CLASS="l">506</TD><TD>                        System.out.println(&#34;already being initialized&#34;); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">507</TD><TD>                }</TD></TR><TR><TD CLASS="l">508</TD><TD> </TD></TR><TR><TD CLASS="l">509</TD><TD>                try {</TD></TR><TR CLASS="z"><TD CLASS="l">510</TD><TD>                        model.aboutToChangeModel();</TD></TR><TR CLASS="z"><TD CLASS="l">511</TD><TD>                        model.setReinitializeStateData(new EmbeddedTypeStateData(oldHandler, newHandler));</TD></TR><TR CLASS="z"><TD CLASS="l">512</TD><TD>                        model.setReinitializeNeeded(true);</TD></TR><TR><TD CLASS="l">513</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">514</TD><TD>                finally {</TD></TR><TR CLASS="z"><TD CLASS="l">515</TD><TD>                        model.changedModel();</TD></TR><TR CLASS="z"><TD CLASS="l">516</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">517</TD><TD>        }</TD></TR><TR><TD CLASS="l">518</TD><TD> </TD></TR><TR><TD CLASS="l">519</TD><TD>        /**</TD></TR><TR><TD CLASS="l">520</TD><TD>         * Method modelReinitNeeded.</TD></TR><TR><TD CLASS="l">521</TD><TD>         */</TD></TR><TR><TD CLASS="l"><A NAME="1a">522</A></TD><TD>        private void modelReinitNeeded(String oldlanguage, String newLanguage) {</TD></TR><TR><TD CLASS="l">523</TD><TD>                // bit of a short cut for now .... we dont' need language at the</TD></TR><TR><TD CLASS="l">524</TD><TD>                // moment,</TD></TR><TR><TD CLASS="l">525</TD><TD>                // but should set the state data</TD></TR><TR CLASS="z"><TD CLASS="l">526</TD><TD>                if (model.isReinitializationNeeded()) {</TD></TR><TR><TD CLASS="l">527</TD><TD>                        if (Debug.displayWarnings) {</TD></TR><TR><TD CLASS="l">528</TD><TD>                                System.out.println(&#34;already being initialized&#34;); //$NON-NLS-1$</TD></TR><TR><TD CLASS="l">529</TD><TD>                        }</TD></TR><TR><TD CLASS="l">530</TD><TD>                }</TD></TR><TR><TD CLASS="l">531</TD><TD>                else {</TD></TR><TR><TD CLASS="l">532</TD><TD>                        try {</TD></TR><TR><TD CLASS="l">533</TD><TD>                                // if already being re-initialized, we don't want to</TD></TR><TR><TD CLASS="l">534</TD><TD>                                // reset the data in the stateData field.</TD></TR><TR CLASS="z"><TD CLASS="l">535</TD><TD>                                model.aboutToChangeModel();</TD></TR><TR CLASS="z"><TD CLASS="l">536</TD><TD>                                model.setReinitializeStateData(newLanguage);</TD></TR><TR CLASS="z"><TD CLASS="l">537</TD><TD>                                model.setReinitializeNeeded(true);</TD></TR><TR><TD CLASS="l">538</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">539</TD><TD>                        finally {</TD></TR><TR CLASS="z"><TD CLASS="l">540</TD><TD>                                model.changedModel();</TD></TR><TR CLASS="z"><TD CLASS="l">541</TD><TD>                        }</TD></TR><TR><TD CLASS="l"><A NAME="1e">542</A></TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">543</TD><TD>        }</TD></TR><TR><TD CLASS="l">544</TD><TD> </TD></TR><TR><TD CLASS="l">545</TD><TD>        public void setCachedLanguage(String newLanguage) {</TD></TR><TR CLASS="z"><TD CLASS="l">546</TD><TD>                if (cachedLanguage != null &amp;&amp; languageStateChanged(cachedLanguage, newLanguage)) {</TD></TR><TR><TD CLASS="l">547</TD><TD>                        /*</TD></TR><TR><TD CLASS="l">548</TD><TD>                         * a complete re-init overkill in current system, since really</TD></TR><TR><TD CLASS="l">549</TD><TD>                         * just need for the line style providers, BUT, a change in</TD></TR><TR><TD CLASS="l">550</TD><TD>                         * language could effect other things, and we don't expect to</TD></TR><TR><TD CLASS="l">551</TD><TD>                         * happen often so a little overkill isn't too bad. The deep</TD></TR><TR><TD CLASS="l">552</TD><TD>                         * problem is that there is no way to get at the &#34;edit side&#34;</TD></TR><TR><TD CLASS="l">553</TD><TD>                         * adpapters specifically here in model class. we have to do the</TD></TR><TR><TD CLASS="l">554</TD><TD>                         * model changed sequence to get the screen to update. do not</TD></TR><TR><TD CLASS="l">555</TD><TD>                         * signal again, if signaled once (the reinit state data will be</TD></TR><TR><TD CLASS="l">556</TD><TD>                         * wrong. (this needs to be improved in future)</TD></TR><TR><TD CLASS="l">557</TD><TD>                         */</TD></TR><TR CLASS="z"><TD CLASS="l">558</TD><TD>                        if (!model.isReinitializationNeeded()) {</TD></TR><TR CLASS="z"><TD CLASS="l">559</TD><TD>                                modelReinitNeeded(cachedLanguage, newLanguage);</TD></TR><TR><TD CLASS="l">560</TD><TD>                        }</TD></TR><TR><TD CLASS="l">561</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">562</TD><TD>                setLanguage(newLanguage);</TD></TR><TR CLASS="z"><TD CLASS="l">563</TD><TD>        }</TD></TR><TR><TD CLASS="l">564</TD><TD> </TD></TR><TR><TD CLASS="l">565</TD><TD>        /**</TD></TR><TR><TD CLASS="l"><A NAME="20">566</A></TD><TD>         * This is public access method, used especially from loader, for JSP</TD></TR><TR><TD CLASS="l">567</TD><TD>         * Fragment support.</TD></TR><TR><TD CLASS="l">568</TD><TD>         */</TD></TR><TR><TD CLASS="l">569</TD><TD>        public void setLanguage(String newLanguage) {</TD></TR><TR CLASS="z"><TD CLASS="l">570</TD><TD>                this.cachedLanguage = newLanguage;</TD></TR><TR CLASS="z"><TD CLASS="l">571</TD><TD>                IDocumentPartitioner partitioner = ((IDocumentExtension3) model.getStructuredDocument()).getDocumentPartitioner(IStructuredPartitioning.DEFAULT_STRUCTURED_PARTITIONING);</TD></TR><TR CLASS="z"><TD CLASS="l">572</TD><TD>                if (partitioner instanceof StructuredTextPartitionerForJSP) {</TD></TR><TR CLASS="z"><TD CLASS="l">573</TD><TD>                        ((StructuredTextPartitionerForJSP) partitioner).setLanguage(newLanguage);</TD></TR><TR><TD CLASS="l">574</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">575</TD><TD>        }</TD></TR><TR><TD CLASS="l">576</TD><TD> </TD></TR><TR><TD CLASS="l">577</TD><TD>        /**</TD></TR><TR><TD CLASS="l">578</TD><TD>         * Method languageStateChange.</TD></TR><TR><TD CLASS="l">579</TD><TD>         * </TD></TR><TR><TD CLASS="l">580</TD><TD>         * @param cachedLanguage</TD></TR><TR><TD CLASS="l"><A NAME="18">581</A></TD><TD>         * @param newLanguage</TD></TR><TR><TD CLASS="l">582</TD><TD>         * @return boolean</TD></TR><TR><TD CLASS="l">583</TD><TD>         */</TD></TR><TR><TD CLASS="l">584</TD><TD>        private boolean languageStateChanged(String cachedLanguage, String newLanguage) {</TD></TR><TR CLASS="z"><TD CLASS="l">585</TD><TD>                boolean result = false; // languages are equal, then no change in</TD></TR><TR><TD CLASS="l">586</TD><TD>                // state</TD></TR><TR CLASS="z"><TD CLASS="l">587</TD><TD>                if (!cachedLanguage.equalsIgnoreCase(newLanguage)) {</TD></TR><TR CLASS="z"><TD CLASS="l">588</TD><TD>                        boolean oldLanguageKnown = languageKnown(cachedLanguage);</TD></TR><TR CLASS="z"><TD CLASS="l">589</TD><TD>                        boolean newLanguageKnown = languageKnown(newLanguage);</TD></TR><TR CLASS="z"><TD CLASS="l">590</TD><TD>                        result = newLanguageKnown || (!newLanguageKnown &amp;&amp; oldLanguageKnown);</TD></TR><TR><TD CLASS="l">591</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">592</TD><TD>                return result;</TD></TR><TR><TD CLASS="l">593</TD><TD>        }</TD></TR><TR><TD CLASS="l">594</TD><TD> </TD></TR><TR><TD CLASS="l">595</TD><TD>        /**</TD></TR><TR><TD CLASS="l">596</TD><TD>         * Method languageKnown.</TD></TR><TR><TD CLASS="l">597</TD><TD>         * </TD></TR><TR><TD CLASS="l"><A NAME="17">598</A></TD><TD>         * @param cachedLanguage</TD></TR><TR><TD CLASS="l">599</TD><TD>         * @return boolean</TD></TR><TR><TD CLASS="l">600</TD><TD>         */</TD></TR><TR><TD CLASS="l">601</TD><TD>        private boolean languageKnown(String language) {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="10">602</A></TD><TD>                return (StringUtils.contains(JAVA_LANGUAGE_KEYS, language, false) || StringUtils.contains(JAVASCRIPT_LANGUAGE_KEYS, language, false));</TD></TR><TR><TD CLASS="l">603</TD><TD>        }</TD></TR><TR><TD CLASS="l">604</TD><TD> </TD></TR><TR><TD CLASS="l">605</TD><TD>        private IFile getFile(IStructuredModel model) {</TD></TR><TR CLASS="z"><TD CLASS="l">606</TD><TD>                String location = model.getBaseLocation();</TD></TR><TR CLASS="z"><TD CLASS="l">607</TD><TD>                if (location != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">608</TD><TD>                        IPath path = new Path(location);</TD></TR><TR CLASS="z"><TD CLASS="l">609</TD><TD>                        if (path.segmentCount() &gt; 1) {</TD></TR><TR CLASS="z"><TD CLASS="l">610</TD><TD>                                return ResourcesPlugin.getWorkspace().getRoot().getFile(path);</TD></TR><TR><TD CLASS="l">611</TD><TD>                        }</TD></TR><TR><TD CLASS="l">612</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="11">613</A></TD><TD>                return null;</TD></TR><TR><TD CLASS="l">614</TD><TD>        }</TD></TR><TR><TD CLASS="l">615</TD><TD> </TD></TR><TR><TD CLASS="l">616</TD><TD>        private EmbeddedTypeHandler getHandlerFor(String contentType) {</TD></TR><TR CLASS="z"><TD CLASS="l">617</TD><TD>                EmbeddedTypeRegistry reg = getEmbeddedContentTypeRegistry();</TD></TR><TR CLASS="z"><TD CLASS="l">618</TD><TD>                EmbeddedTypeHandler handler = null;</TD></TR><TR CLASS="z"><TD CLASS="l">619</TD><TD>                if (reg != null)</TD></TR><TR CLASS="z"><TD CLASS="l">620</TD><TD>                        handler = reg.getTypeFor(contentType);</TD></TR><TR CLASS="z"><TD CLASS="l">621</TD><TD>                return handler;</TD></TR><TR><TD CLASS="l">622</TD><TD>        }</TD></TR><TR><TD CLASS="l">623</TD><TD> </TD></TR><TR><TD CLASS="l">624</TD><TD>        /**</TD></TR><TR><TD CLASS="l">625</TD><TD>         * Gets the embeddedContentTypeRegistry.</TD></TR><TR><TD CLASS="l"><A NAME="e">626</A></TD><TD>         * </TD></TR><TR><TD CLASS="l">627</TD><TD>         * @return Returns a EmbeddedContentTypeRegistry</TD></TR><TR><TD CLASS="l">628</TD><TD>         */</TD></TR><TR><TD CLASS="l">629</TD><TD>        private EmbeddedTypeRegistry getEmbeddedContentTypeRegistry() {</TD></TR><TR CLASS="z"><TD CLASS="l">630</TD><TD>                return EmbeddedTypeRegistryImpl.getInstance();</TD></TR><TR><TD CLASS="l">631</TD><TD>        }</TD></TR><TR><TD CLASS="l">632</TD><TD> </TD></TR><TR><TD CLASS="l">633</TD><TD>        /**</TD></TR><TR><TD CLASS="l">634</TD><TD>         * For JSP files, text/html is the default content type. This may want</TD></TR><TR><TD CLASS="l">635</TD><TD>         * this different for types like jsv (jsp for voice xml) For now, hard</TD></TR><TR><TD CLASS="l">636</TD><TD>         * code to new instance. In future, should get instance from registry.</TD></TR><TR><TD CLASS="l"><A NAME="c">637</A></TD><TD>         * </TD></TR><TR><TD CLASS="l">638</TD><TD>         * Specification cites HTML as the default contentType.</TD></TR><TR><TD CLASS="l">639</TD><TD>         */</TD></TR><TR><TD CLASS="l">640</TD><TD>        protected EmbeddedTypeHandler getDefaultEmbeddedType() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="14">641</A></TD><TD>                return getHandlerFor(getDefaultContentType());</TD></TR><TR><TD CLASS="l">642</TD><TD>        }</TD></TR><TR><TD CLASS="l">643</TD><TD> </TD></TR><TR><TD CLASS="l">644</TD><TD>        public INodeNotifier getTarget() {</TD></TR><TR CLASS="z"><TD CLASS="l"><A NAME="1c">645</A></TD><TD>                return notifierAtCreation;</TD></TR><TR><TD CLASS="l">646</TD><TD>        }</TD></TR><TR><TD CLASS="l">647</TD><TD> </TD></TR><TR><TD CLASS="l">648</TD><TD>        public void release() {</TD></TR><TR CLASS="z"><TD CLASS="l">649</TD><TD>                if (embeddedTypeHandler != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">650</TD><TD>                        if (embeddedFactoryRegistry != null) {</TD></TR><TR CLASS="z"><TD CLASS="l">651</TD><TD>                                Iterator iterator = embeddedFactoryRegistry.iterator();</TD></TR><TR CLASS="z"><TD CLASS="l">652</TD><TD>                                INodeAdapterFactory factory = null;</TD></TR><TR CLASS="z"><TD CLASS="l">653</TD><TD>                                while (iterator.hasNext()) {</TD></TR><TR CLASS="z"><TD CLASS="l">654</TD><TD>                                        factory = (INodeAdapterFactory) iterator.next();</TD></TR><TR CLASS="z"><TD CLASS="l">655</TD><TD>                                        factory.release();</TD></TR><TR><TD CLASS="l">656</TD><TD>                                }</TD></TR><TR><TD CLASS="l">657</TD><TD>                        }</TD></TR><TR><TD CLASS="l">658</TD><TD>                        // pa_TODO: possibly need to release here...</TD></TR><TR><TD CLASS="l">659</TD><TD>                        // or &#34;uninitializeFactoryRegistry&#34;</TD></TR><TR><TD CLASS="l">660</TD><TD>                        // initializeFactoryRegistry was called from JSPModelLoader</TD></TR><TR CLASS="z"><TD CLASS="l">661</TD><TD>                        embeddedTypeHandler = null;</TD></TR><TR><TD CLASS="l"><A NAME="8">662</A></TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">663</TD><TD>        }</TD></TR><TR><TD CLASS="l">664</TD><TD> </TD></TR><TR><TD CLASS="l">665</TD><TD>        private IContentDescription getContentDescription(IDocument doc) {</TD></TR><TR CLASS="z"><TD CLASS="l">666</TD><TD>                if (doc == null)</TD></TR><TR CLASS="z"><TD CLASS="l">667</TD><TD>                        return null;</TD></TR><TR CLASS="z"><TD CLASS="l">668</TD><TD>                DocumentReader in = new DocumentReader(doc);</TD></TR><TR CLASS="z"><TD CLASS="l">669</TD><TD>                return getContentDescription(in);</TD></TR><TR><TD CLASS="l">670</TD><TD>        }</TD></TR><TR><TD CLASS="l">671</TD><TD> </TD></TR><TR><TD CLASS="l">672</TD><TD>        /**</TD></TR><TR><TD CLASS="l">673</TD><TD>         * Returns content description for an input stream Assumes it's JSP</TD></TR><TR><TD CLASS="l">674</TD><TD>         * content. Closes the input stream when finished.</TD></TR><TR><TD CLASS="l">675</TD><TD>         * </TD></TR><TR><TD CLASS="l">676</TD><TD>         * @param in</TD></TR><TR><TD CLASS="l"><A NAME="9">677</A></TD><TD>         * @return the IContentDescription for in, or null if in is null</TD></TR><TR><TD CLASS="l">678</TD><TD>         */</TD></TR><TR><TD CLASS="l">679</TD><TD>        private IContentDescription getContentDescription(Reader in) {</TD></TR><TR><TD CLASS="l">680</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">681</TD><TD>                if (in == null)</TD></TR><TR CLASS="z"><TD CLASS="l">682</TD><TD>                        return null;</TD></TR><TR><TD CLASS="l">683</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">684</TD><TD>                IContentDescription desc = null;</TD></TR><TR><TD CLASS="l">685</TD><TD>                try {</TD></TR><TR><TD CLASS="l">686</TD><TD> </TD></TR><TR CLASS="z"><TD CLASS="l">687</TD><TD>                        IContentType contentTypeJSP = Platform.getContentTypeManager().getContentType(ContentTypeIdForJSP.ContentTypeID_JSP);</TD></TR><TR CLASS="z"><TD CLASS="l">688</TD><TD>                        desc = contentTypeJSP.getDescriptionFor(in, IContentDescription.ALL);</TD></TR><TR><TD CLASS="l">689</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">690</TD><TD>                catch (IOException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">691</TD><TD>                        Logger.logException(e);</TD></TR><TR><TD CLASS="l">692</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">693</TD><TD>                finally {</TD></TR><TR><TD CLASS="l">694</TD><TD>                        try {</TD></TR><TR CLASS="z"><TD CLASS="l">695</TD><TD>                                in.close();</TD></TR><TR><TD CLASS="l">696</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">697</TD><TD>                        catch (IOException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">698</TD><TD>                                Logger.logException(e);</TD></TR><TR><TD CLASS="l">699</TD><TD>                        }</TD></TR><TR CLASS="z"><TD CLASS="l">700</TD><TD>                }</TD></TR><TR CLASS="z"><TD CLASS="l">701</TD><TD>                return desc;</TD></TR><TR><TD CLASS="l">702</TD><TD>        }</TD></TR><TR><TD CLASS="l">703</TD><TD>}</TD></TR></TABLE><P></P><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="nv">[<A HREF="../xslUnitTestCoverage.html">all classes</A>][<A HREF="8.html">org.eclipse.jst.jsp.core.internal.document</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://www.eclemma.org/support.html">EMMA 2.0.5312 EclEmma Fix 1</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>